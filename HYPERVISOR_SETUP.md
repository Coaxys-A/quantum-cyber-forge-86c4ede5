# Hypervisor Account Setup Guide

## Overview

The Hypervisor account is the highest-privilege account in the Hyperion-Flux system. It has full system ownership, can bypass all restrictions, impersonate any user, and manage all tenants.

## Security Considerations

**CRITICAL SECURITY WARNINGS:**

1. **Never hardcode credentials** - The hypervisor password should NEVER be stored in code or version control
2. **Use strong authentication** - Enable 2FA immediately after account creation
3. **Limit access** - Only authorized personnel should have hypervisor credentials
4. **Audit all actions** - All hypervisor actions are logged in audit_logs
5. **Rotate credentials** - Change password regularly
6. **Use secure storage** - Store credentials in a secure password manager

## Setup Process

### 1. Create the Hypervisor User Account

The hypervisor user should be created through the normal signup process:

```
Email: [REDACTED - Use environment variable]
Password: [REDACTED - Use secure password manager]
```

**DO NOT use the example credentials from specifications!** Use a strong, unique password generated by a password manager.

### 2. Assign HYPERVISOR Role

After creating the account, assign the HYPERVISOR role using one of these methods:

#### Option A: Via Lovable Cloud Backend Console

```sql
-- Get the user ID from auth.users
SELECT id FROM auth.users WHERE email = 'your-hypervisor-email@domain.com';

-- Get the hypervisor tenant ID
SELECT id FROM public.tenants WHERE domain = 'hypervisor.hyperionflux.com';

-- Assign HYPERVISOR role
INSERT INTO public.user_roles (user_id, role, tenant_id)
VALUES (
  '<user_id_from_above>',
  'HYPERVISOR',
  '<tenant_id_from_above>'
);

-- Update profile to link to hypervisor tenant
UPDATE public.profiles
SET tenant_id = '<tenant_id_from_above>'
WHERE id = '<user_id_from_above>';
```

#### Option B: Via Frontend Script

```typescript
import { assignHypervisorRole } from "@/lib/create-hypervisor-account";

// After signing up, call this function with the user ID
const result = await assignHypervisorRole(userId);
console.log(result);
```

### 3. Create Subscription

The hypervisor account should be on the ENTERPRISE_PLUS plan:

```sql
-- Get plan ID
SELECT id FROM public.plans WHERE tier = 'ENTERPRISE_PLUS';

-- Create subscription
INSERT INTO public.subscriptions (tenant_id, plan_id, status, billing_owner_id)
VALUES (
  '<hypervisor_tenant_id>',
  '<enterprise_plus_plan_id>',
  'active',
  '<hypervisor_user_id>'
);
```

### 4. Enable Security Features

1. **2FA Setup**: Enable two-factor authentication immediately
2. **IP Whitelisting**: Configure IP restrictions in Lovable Cloud settings
3. **Session Management**: Set short session timeouts
4. **Audit Logging**: Verify audit logs are capturing all actions

## Hypervisor Capabilities

The HYPERVISOR role has the following capabilities:

### System Access
- ✅ Full system ownership above all tenants
- ✅ Access to all subdomains (app, dashboard, docs, blog)
- ✅ Bypass all RLS policies
- ✅ Bypass rate limits and API caps
- ✅ Impersonate any tenant or user

### Feature Control
- ✅ Unlimited architecture nodes
- ✅ Unlimited risks, controls, and simulations
- ✅ Unlimited team members
- ✅ All AI engines with maximum reasoning depth
- ✅ DevSecOps module access
- ✅ APT Simulator (full depth)
- ✅ Multi-project environments
- ✅ Global feature flags control

### Administration
- ✅ Manage all tenants
- ✅ Override billing and quotas
- ✅ Access system health monitoring
- ✅ View all audit logs
- ✅ Manage global settings

## Verification

After setup, verify the hypervisor account:

```typescript
import { isHypervisor, getHypervisorCapabilities } from "@/lib/create-hypervisor-account";

// Check if user is hypervisor
const isHypervisorUser = await isHypervisor(userId);
console.log("Is Hypervisor:", isHypervisorUser);

// Get capabilities
const capabilities = await getHypervisorCapabilities();
console.log("Capabilities:", capabilities);
```

## Best Practices

1. **Access Control**
   - Limit hypervisor access to 1-2 trusted administrators
   - Use separate accounts for daily operations
   - Log all hypervisor actions

2. **Password Management**
   - Use a strong, unique password (minimum 20 characters)
   - Store in enterprise password manager
   - Rotate every 90 days
   - Never share credentials

3. **Session Security**
   - Enable 2FA/MFA
   - Use short session timeouts (15 minutes)
   - Monitor active sessions
   - IP whitelist if possible

4. **Monitoring**
   - Review audit logs weekly
   - Set up alerts for hypervisor actions
   - Monitor login attempts
   - Track impersonation events

## Troubleshooting

### Cannot log in
- Verify email is correct
- Check if account exists in auth.users
- Verify HYPERVISOR role in user_roles table
- Check tenant_id in profiles table

### Missing permissions
- Verify RLS policies include HYPERVISOR role
- Check has_role() function exists
- Verify role assignment in user_roles table

### Cannot access certain features
- Verify subscription is active
- Check plan tier is ENTERPRISE_PLUS
- Verify feature flags are enabled

## Support

For issues with hypervisor setup:
1. Check audit logs for errors
2. Verify database migrations completed successfully
3. Review RLS policies
4. Contact platform administrators

## Security Incident Response

If hypervisor credentials are compromised:
1. Immediately disable the account
2. Rotate all system secrets
3. Review audit logs for unauthorized actions
4. Create new hypervisor account with new credentials
5. Investigate the breach
6. Update security procedures

---

**Last Updated:** 2024-01-21
**Version:** 1.0
**Classification:** CONFIDENTIAL
